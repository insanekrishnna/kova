<% layout("/layouts/boilerplate") %>
<body>
  <div class="container my-5 px-3">
    <% if (!listing) { %>
      <div class="alert alert-warning">Listing not available</div>
    <% } else { %>
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-4">
            <img src="<%= listing.image && listing.image.url ? listing.image.url : '/images/placeholder.png' %>" alt="listing_image" class="card-img-top mt-3" style="height:330px; max-width: 95%; margin: auto;  object-fit:cover;">
            <div class="card-body p-4">
              <h4 class="fw-semibold text-dark mb-2"><%= listing.title %></h4>
              <p class="text-muted small mb-2">
                Owned by <span class="fst-italic"><%= listing.owner && listing.owner.username ? listing.owner.username : "Unknown" %></span>
              </p>
              <p class="text-secondary small mb-4"><%= listing.description %></p>
              
              <div class="border-top pt-3">
                <div class="d-flex justify-content-between align-items-center gap-2 mb-2 flex-wrap">
                  <div>
                    <h6 class="fw-semibold text-dark mb-0">â‚¹<%= listing.price ? listing.price.toLocaleString("en-IN") : 'N/A' %> <span class="text-muted fw-normal">/night</span></h6>
                    <small class="text-muted"><%= listing.location %><%= listing.country ? ', ' + listing.country : '' %></small>
                  </div>
                  <a href="#" class="btn btn-dark btn-sm rounded-pill px-3"><i class="fa-solid fa-location-dot"></i> <%= listing.country%></a>
                </div>

                <!-- Edit/Delete - SAFE CHECK -->
                <% if (currUser && listing.owner && String(currUser._id) === String(listing.owner._id)) { %>
                  <div class="d-flex gap-2">
                    <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-dark btn-sm rounded-3 px-4">Edit</a>
                    <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="m-0">
                      <button type="button" class="btn btn-outline-danger btn-sm rounded-3" onclick="if(confirm('Delete this listing?')) this.form.submit();">Delete</button>
                    </form>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reviews Section -->
      <div class="col-8 offset-2 mb-3 mt-4">
        <% if (currUser) { %>
          <h4 class="fw-semibold mb-3">Feel free to drop a review !</h4>
          <form action="/listings/<%= listing._id %>/reviews" method="POST" class="review-form-wrapper">
            <div class="mb-3">
              <label class="form-label small">Rating</label>
              <div class="stars-container" id="starsContainer">
                <input type="hidden" name="review[rating]" id="ratingInput" value="0">
                <% for (let i = 1; i <= 5; i++) { %>
                  <i class="fa-solid fa-star review-star" data-rating="<%= i %>" style="cursor:pointer; font-size:1.5rem; margin-right:0.5rem; color:#ddd; transition: all 0.2s ease;"></i>
                <% } %>
              </div>
              <small class="text-danger d-block mt-2" id="ratingError" style="display:none;">Please select a rating</small>
            </div>
            <div class="mb-3">
              <label class="form-label border badge text-dark">Comment</label>
              <textarea name="review[comment]" cols="30" rows="3" class="form-control shadow-sm border-0 rounded-3" required></textarea>
            </div>
            <button type="submit" class="btn btn-outline-dark btn-sm rounded-pill px-4 ms-1">Submit</button>
          </form>
        <% } else { %>
          <p class="text-muted"><a href="/login">Login</a> to leave a review</p>
        <% } %>

        <hr class="my-4">
        
        <!-- Display Reviews -->
        <h5 class="fw-semibold mb-3 badge text-dark border">Reviews <i class="fa-solid fa-fingerprint"></i></h5>
        <% if (listing.reviews && listing.reviews.length > 0) { %>
          <% for (let review of listing.reviews) { %>
            <div class="card p-3 mb-2 col-8  border-0  shadow-sm">
              <h6 class="fw-bold mb-2">@<%= review.author ? review.author.username : 'Unknown' %></h6>
              <div class="mb-2">
                <% for (let i = 1; i <= 5; i++) { %>
                  <i class="fa-<%= i <= review.rating ? 'solid' : 'regular' %> fa-star" style="color:#ffc107;"></i>
                <% } %>
              </div>
              <p class="mb-2"><%= review.comment %></p>
              <% if (currUser && review.author && String(currUser._id) === String(review.author._id)) { %>
                <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" class="d-inline">
                  <button type="button" class="btn btn-sm btn-danger" onclick="if(confirm('Delete review?')) this.form.submit();">Delete</button>
                </form>
              <% } %>
            </div>
          <% } %>
        <% } else { %>
          <p class="text-muted">No reviews yet</p>
        <% } %>
      </div>
    <% } %>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const stars = document.querySelectorAll('.review-star');
      const ratingInput = document.getElementById('ratingInput');
      const ratingError = document.getElementById('ratingError');
      const form = document.querySelector('.review-form-wrapper');

      // Function to update star colors
      function updateStars(rating) {
        stars.forEach(star => {
          const starRating = parseInt(star.getAttribute('data-rating'));
          if (starRating <= rating) {
            star.style.color = '#ffc107';
          } else {
            star.style.color = '#ddd';
          }
        });
      }

      // Click handler
      stars.forEach(star => {
        star.addEventListener('click', function() {
          const rating = parseInt(this.getAttribute('data-rating'));
          ratingInput.value = rating;
          ratingError.style.display = 'none';
          updateStars(rating);
        });

        // Hover effect
        star.addEventListener('mouseover', function() {
          const hoverRating = parseInt(this.getAttribute('data-rating'));
          stars.forEach(s => {
            const sRating = parseInt(s.getAttribute('data-rating'));
            if (sRating <= hoverRating) {
              s.style.color = '#ffc107';
            } else {
              s.style.color = '#ddd';
            }
          });
        });
      });

      // Mouse leave - restore selected rating color
      const starsContainer = document.getElementById('starsContainer');
      if (starsContainer) {
        starsContainer.addEventListener('mouseleave', function() {
          const currentRating = parseInt(ratingInput.value);
          updateStars(currentRating);
        });
      }

      // Form submit validation
      if (form) {
        form.addEventListener('submit', function(e) {
          if (ratingInput.value === '0') {
            e.preventDefault();
            ratingError.style.display = 'block';
            return false;
          }
        });
      }
    });
  </script>
</body>